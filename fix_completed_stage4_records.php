<?php

/**
 * ุณูุฑูุจุช ูุฅุตูุงุญ ุณุฌูุงุช ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ ุงูููุชููุฉ ูู worker_stage_history
 * ูุชู ุฅุบูุงู ุงูุณุฌูุงุช ุงููุดุทุฉ ููุตูุงุฏูู ุงูุชู ูุตูุช ูููุณุชูุฏุน
 */

require __DIR__.'/vendor/autoload.php';

$app = require_once __DIR__.'/bootstrap/app.php';
$app->make(Illuminate\Contracts\Console\Kernel::class)->bootstrap();

use Illuminate\Support\Facades\DB;

echo "\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "โ   ๐ง ุฅุตูุงุญ ุณุฌูุงุช ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ ุงูููุชููุฉ                   โ\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "\n";

// ุงูุจุญุซ ุนู ุงูุตูุงุฏูู ุงูููุชููุฉ (ูู ุงููุณุชูุฏุน ุฃู ุชู ุดุญููุง)
$completedBoxes = DB::table('stage4_boxes')
    ->whereIn('status', ['in_warehouse', 'shipped', 'delivered'])
    ->select('id', 'barcode', 'status')
    ->get();

echo "๐ฆ ุนุฏุฏ ุงูุตูุงุฏูู ุงูููุชููุฉ: " . $completedBoxes->count() . "\n\n";

$fixedCount = 0;
$alreadyClosedCount = 0;

foreach ($completedBoxes as $box) {
    // ุงูุจุญุซ ุนู ุณุฌูุงุช ูุดุทุฉ ููุฐุง ุงูุตูุฏูู
    $activeRecords = DB::table('worker_stage_history')
        ->where('stage_type', 'stage4_boxes')
        ->where('stage_record_id', $box->id)
        ->where('is_active', true)
        ->get();

    if ($activeRecords->count() > 0) {
        echo "โ๏ธ  ุงูุตูุฏูู {$box->barcode} (ุงูุญุงูุฉ: {$box->status})\n";
        echo "   ูุฌุฏูุง {$activeRecords->count()} ุณุฌู ูุดุท\n";
        
        // ุฅููุงุก ูุฐู ุงูุณุฌูุงุช
        $updated = DB::table('worker_stage_history')
            ->where('stage_type', 'stage4_boxes')
            ->where('stage_record_id', $box->id)
            ->where('is_active', true)
            ->update([
                'is_active' => false,
                'ended_at' => now(),
                'duration_minutes' => DB::raw('TIMESTAMPDIFF(MINUTE, started_at, NOW())'),
                'status_after' => 'completed',
                'updated_at' => now()
            ]);
        
        echo "   โ ุชู ุฅููุงุก {$updated} ุณุฌู\n\n";
        $fixedCount += $updated;
    } else {
        $alreadyClosedCount++;
    }
}

echo "\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "โ   ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ                                       โ\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ\n";
echo "โ   โ ุชู ุฅุตูุงุญ: {$fixedCount} ุณุฌู                                      โ\n";
echo "โ   โ  ุตุญูุญ ุจุงููุนู: {$alreadyClosedCount} ุตูุฏูู                            โ\n";
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n";
echo "\n";

if ($fixedCount > 0) {
    echo "โจ ุชู ุฅุตูุงุญ ุงูุณุฌูุงุช ุจูุฌุงุญ!\n";
    echo "   ููููู ุงูุขู ูุชุญ ุตูุญุฉ 'ุงูุนูููุงุช ุบูุฑ ุงูููุชููุฉ' ูุงูุชุญูู.\n";
} else {
    echo "โ ูุง ุชูุฌุฏ ุณุฌูุงุช ุชุญุชุงุฌ ุฅุตูุงุญ. ุฌููุน ุงูุณุฌูุงุช ุตุญูุญุฉ!\n";
}

echo "\n";
