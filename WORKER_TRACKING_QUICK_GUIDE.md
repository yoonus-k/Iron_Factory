# ุฏููู ูุธุงู ุชุชุจุน ุงูุนูุงู - ูุฑุฌุน ุณุฑูุน

## ๐ฏ ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. ุชุณุฌูู ุชุชุจุน ุงูุนูุงู ุชููุงุฆูุงู
- โ ุนูุฏ ุฅูุดุงุก ูุฑุฏูุฉ ุฌุฏูุฏุฉ
- โ ุนูุฏ ุชุญุฏูุซ ุงูุนูุงู ูู ุงููุฑุฏูุฉ
- โ **ุนูุฏ ููู ุงููุฑุฏูุฉ** โ ูุฐุง ูุงู ุงูุญู ุงูุฑุฆูุณู

### 2. ุณุฌู ูุงูู ููุนูููุงุช
ูู ุนูููุฉ ุนูู ุงููุฑุฏูุฉ ุชูุณุฌู ูุน:
- ุงูุจูุงูุงุช ุงููุฏููุฉ (before)
- ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ (after)
- ููุช ุงูุนูููุฉ ูุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจูุง

### 3. ุนุฑุถ ุงูุนูุงู ุงูุญุงูููู
ูู ูู ูุฑุญูุฉุ ููููู ุฑุคูุฉ:
- ุงุณู ุงูุนุงูู
- ููุฏ ุงููุฑุฏูุฉ ุงูุฎุงุตุฉ ุจู
- ููุช ุงูุจุฏุก
- ุงููุฏุฉ ุงูุญุงููุฉ

---

## ๐ ุงูุฌุฏุงูู ุงูุฑุฆูุณูุฉ

### `worker_stage_history` - ุชุชุจุน ุญุฑูุฉ ุงูุนูุงู
```sql
-- ุฌูุจ ุงูุนูุงู ุงููุดุทูู ุญุงููุงู ูู ุงููุฑุญูุฉ 1
SELECT * FROM worker_stage_history 
WHERE stage_type = 'stage1_stands'
  AND is_active = true
  AND ended_at IS NULL;
```

### `shift_operation_logs` - ุณุฌู ุงูุนูููุงุช
```sql
-- ุฌูุจ ุฌููุน ูููุงุช ุงููุฑุฏูุฉ ุงูููู
SELECT * FROM shift_operation_logs 
WHERE operation_type = 'transfer'
  AND DATE(created_at) = CURDATE();
```

---

## ๐ง ุงูุฏูุงู ุงููุณุชุฎุฏูุฉ

### ูู `ShiftsWorkersController`

```php
// ุนูุฏ ุฅูุดุงุก ูุฑุฏูุฉ
public function store(Request $request) {
    // ... ุงูุชุญูู ูุงูุฅูุดุงุก
    
    // ุชุณุฌูู ุชุชุจุน ุงูุนูุงู
    foreach ($workerIds as $workerId) {
        WorkerStageHistory::create([
            'stage_type' => 'stage1_stands',
            'worker_id' => $workerId,
            'started_at' => now(),
            'is_active' => true,
            'shift_assignment_id' => $shift->id,
        ]);
    }
}

// ุนูุฏ ููู ุงููุฑุฏูุฉ
public function transferStore(Request $request, $id) {
    // ... ุงูุชุญูู ูุงูุชุญุฏูุซ
    
    // 1. ุฅููุงุก ุงูุนูุงู ุงููุฏุงูู
    WorkerStageHistory::where('shift_assignment_id', $shift->id)
        ->whereNull('ended_at')
        ->update(['ended_at' => now(), 'is_active' => false]);
    
    // 2. ุฅุถุงูุฉ ุงูุนูุงู ุงูุฌุฏุฏ
    foreach ($newWorkerIds as $workerId) {
        WorkerStageHistory::create([...]);
    }
}
```

---

## ๐ฑ ููููุฉ ุงูุงุณุชุฎุฏุงู ูู ุงููุงุฌูุฉ

### ุนูุฏ ููู ูุฑุฏูุฉ:

1. ุงูุชุญ ุงููุฑุฏูุฉ ุงููุฑุงุฏ ููููุง
2. ุงุถุบุท ุนูู "ููู ุงููุฑุฏูุฉ"
3. ุงุฎุชุฑ ุงููุณุคูู ุงูุฌุฏูุฏ
4. ุงุฎุชุฑ ุงูุนูุงู ุงูุฌุฏุฏ
5. ุฃุถู ููุงุญุธุฉ (ุงุฎุชูุงุฑู)
6. ุงุถุบุท "ููู"

**ุงููุชูุฌุฉ:**
- โ ูุชู ุชุณุฌูู ุงูุนูููุฉ ูู ุณุฌู ุงูุนูููุงุช
- โ ูุชู ุฅููุงุก ุชุชุจุน ุงูุนูุงู ุงููุฏุงูู
- โ ูุชู ุฅุถุงูุฉ ุงูุนูุงู ุงูุฌุฏุฏ ูู ุชุชุจุน ุงูุนูุงู
- โ ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุคูู ุงูุฌุฏูุฏ

### ุนุฑุถ ุชุชุจุน ุงูุนูุงู:

1. ุงูุชุญ ุตูุญุฉ ุงููุฑุญูุฉ (ูุซู: ุงููุฑุญูุฉ 1 - ุงูุงุณุชุงูุฏุงุช)
2. ุณุชุฌุฏ ูุณููู:
   - **ุงูุนูุงู ูู ุงููุฑุญูุฉ:** ูุงุฆูุฉ ุงูุนูุงู ุงููุดุทูู ุญุงููุงู
   - **ุณุฌู ุงูููู ูุงูุชุนุฏููุงุช:** ุชุงุฑูุฎ ุฌููุน ุงูุนูููุงุช

---

## โ๏ธ ุงูุชูููู ุงูุชููู

### ููุน ุงููุฑุญูุฉ ูุฌุฏูููุง:
| ุงููุฑุญูุฉ | ุงูููุน | ุงูุฌุฏูู |
|--------|-------|--------|
| 1 | stands | stage1_stands |
| 2 | processed | stage2_processed |
| 3 | coils | stage3_coils |
| 4 | boxes | stage4_boxes |

### ุญุงูุงุช ุงูุนุงูู:
```
started_at = ููุช ุจุฏุก ุงูุนุงูู
ended_at = NULL โ ุงูุนุงูู ูุดุท ุญุงููุงู
ended_at = timestamp โ ุงูุนุงูู ุงูุชูู
is_active = true โ ุงููุดุท
is_active = false โ ุงูุบูุฑ ูุดุท
```

---

## ๐ ููููุฉ ุงูุจุญุซ ูุงูุชุญูู

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```php
// ุฌููุน ุงูุนูุงู ุงููุดุทูู ูู ุงููุฑุญูุฉ ุงูุฃููู
$activeWorkers = WorkerStageHistory::where('stage_type', 'stage1_stands')
    ->where('is_active', true)
    ->whereNull('ended_at')
    ->with('worker')
    ->get();

// ุชุงุฑูุฎ ุงูุนูููุงุช ุนูู ูุฑุฏูุฉ ูุนููุฉ
$operations = ShiftOperationLog::where('shift_id', $shiftId)
    ->orderBy('created_at', 'desc')
    ->get();

// ูุฏุฉ ุนูู ุงูุนุงูู ุงูุญุงูู
$workDuration = $history->started_at->diffInMinutes(now());
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### โ ูุนูู ุชููุงุฆูุงู
- ุฅูุดุงุก ูุฑุฏูุฉ โ ุชุณุฌูู ุงูุนูุงู
- ุชุญุฏูุซ ุงููุฑุฏูุฉ โ ุชุญุฏูุซ ุชุชุจุน ุงูุนูุงู
- ููู ุงููุฑุฏูุฉ โ ุฅููุงุก ุงููุฏุงูู ูุฅุถุงูุฉ ุงูุฌุฏุฏ

### โ ุงูุจูุงูุงุช ุขููุฉ
- ุฌููุน ุงูุชุบููุฑุงุช ูุณุฌูุฉ ูู `shift_operation_logs`
- ูููู ุชุชุจุน ูู ูุงู ุจุฃู ุนูููุฉ ููุชู
- ุงูุจูุงูุงุช ุงูุชุงุฑูุฎูุฉ ูู ุชูุญุฐู

### โก ุงูุฃุฏุงุก
- indexed ุนูู `is_active` ู `ended_at`
- ุงุณุชุนูุงูุงุช ูุญุณููุฉ ููุจุญุซ ุงูุณุฑูุน
- ูุง ุชุฃุซุฑ ุนูู ุงูุฃุฏุงุก ุงูุฅุฌูุงููุฉ

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ูุธูุฑ ุงูุนูุงู ูู ุงููุฑุญูุฉ

**ุงูุญู:**
```php
// ุชุญูู ูู:
1. ูู worker_stage_history ูุฏููุง ุจูุงูุงุชุ
   SELECT COUNT(*) FROM worker_stage_history 
   WHERE is_active = true AND ended_at IS NULL;

2. ูู stage_type ุตุญูุญุ
   SELECT DISTINCT stage_type FROM worker_stage_history;

3. ูู shift_assignment_id ููุฌูุฏุ
   SELECT shift_assignment_id FROM worker_stage_history LIMIT 10;
```

### ุงููุดููุฉ: ุฎุทุฃ SQL

**ุงูุณุจุจ:** ุงุณุชุฎุฏุงู ุนููุฏ `status` ุงูุฐู ูุง ููุฌุฏ
**ุงูุญู:** ุงุณุชุฎุฏู `is_active` ู `ended_at`

```php
// โ ุฎุงุทุฆ:
->where('status', 'in_progress')

// โ ุตุญูุญ:
->where('is_active', true)
->whereNull('ended_at')
```

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

### ุงูุญููู ุงููุชุงุญุฉ ูู WorkerStageHistory:
- `id` - ูุนุฑู ุงูุณุฌู
- `stage_type` - ููุน ุงููุฑุญูุฉ
- `stage_record_id` - ูุนุฑู ุงูุณุฌู ูู ุงููุฑุญูุฉ
- `worker_id` - ูุนุฑู ุงูุนุงูู
- `started_at` - ููุช ุงูุจุฏุก
- `ended_at` - ููุช ุงูุงูุชูุงุก
- `duration_minutes` - ุงููุฏุฉ ุจุงูุฏูุงุฆู
- `is_active` - ูู ูุดุท
- `shift_assignment_id` - ุงููุฑุฏูุฉ ุงููุฑุชุจุทุฉ
- `notes` - ููุงุญุธุงุช

---

## ๐ ุงูุฏุนู

ูููุฒูุฏ ูู ุงููุนูููุงุชุ ุฑุงุฌุน:
- `WORKER_TRACKING_FIX_SUMMARY.md` - ููุฎุต ุดุงูู
- `app/Models/WorkerStageHistory.php` - ูููุฐุฌ ุงูุจูุงูุงุช
- `app/Models/ShiftOperationLog.php` - ุณุฌู ุงูุนูููุงุช
- `ShiftsWorkersController.php` - ููุทู ุงูุนูููุงุช

---

**ุขุฎุฑ ุชุญุฏูุซ:** 13 ุฏูุณูุจุฑ 2025
