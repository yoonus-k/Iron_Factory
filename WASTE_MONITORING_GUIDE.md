# ุฏููู ูุธุงู ูุฑุงูุจุฉ ุงููุฏุฑ ูุฅููุงู ุงููุฑุงุญู

## ูุธุฑุฉ ุนุงูุฉ
ุงููุธุงู ูููู ุจูุฑุงูุจุฉ ูุณุจุฉ ุงููุฏุฑ ูู ุงููุฑุงุญู ุงูุฅูุชุงุฌูุฉ ุชููุงุฆูุงูุ ูุนูุฏ ุชุฌุงูุฒ ุงููุณุจุฉ ุงููุณููุญ ุจูุง:
1. **ูููู ุงููุฑุญูุฉ ุชููุงุฆูุงู**
2. **ูุฑุณู ุชูุจููุงุช ูููุณุคูููู**
3. **ูุณุฌู ุจูุงูุงุช ุงูุฅููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**
4. **ูุชุทูุจ ููุงููุฉ ูุงุณุชุฆูุงู ุงูุนูู**

---

## ุงูุฅุนุฏุงุฏุงุช ุงูุซุงุจุชุฉ

ุชู ุฅุถุงูุฉ ุงูุฅุนุฏุงุฏุงุช ุงูุชุงููุฉ ูู `system_settings`:

```php
'production_waste_percentage' => '3'  // ูุณุจุฉ ุงููุฏุฑ ุงููุณููุญ ุจูุง (3%)
'enable_waste_alerts' => '1'          // ุชูุนูู ุงูุชูุจููุงุช
'auto_suspend_on_waste_exceed' => '1' // ุฅููุงู ุงููุฑุญูุฉ ุชููุงุฆูุงู
```

---

## ุงูุตูุงุญูุงุช ุงููุทููุจุฉ

```php
STAGE_SUSPENSION_VIEW      // ุนุฑุถ ุงููุฑุงุญู ุงููููููุฉ
STAGE_SUSPENSION_APPROVE   // ุงูููุงููุฉ ุนูู ุงุณุชุฆูุงู ุงููุฑุญูุฉ
STAGE_SUSPENSION_REJECT    // ุฑูุถ ุงุณุชุฆูุงู ุงููุฑุญูุฉ
```

---

## ููููุฉ ุงูุชุทุจูู ูู ุงููุฑุญูุฉ ุงูุฃููู

### ูู `Stage1Controller.php`

```php
use App\Services\WasteCheckService;

public function store(Request $request)
{
    // ... ุงูููุฏ ุงูุญุงูู ูุญูุธ ุงูุจูุงูุงุช ...
    
    $stand = Stage1Stand::create([
        'input_weight' => $inputWeight,
        'output_weight' => $outputWeight,
        // ... ุจุงูู ุงูุญููู
    ]);
    
    // ๐ฅ ูุญุต ูุณุจุฉ ุงููุฏุฑ ูุฅููุงู ุงููุฑุญูุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ
    $wasteCheck = WasteCheckService::checkAndSuspendIfNeeded(
        stageNumber: 1,
        batchBarcode: $request->barcode,
        inputWeight: $inputWeight,
        outputWeight: $outputWeight,
        batchId: $stand->id,
        userId: Auth::id()
    );
    
    // ุงูุชุญูู ูู ุญุงูุฉ ุงููุญุต
    if ($wasteCheck['suspended']) {
        return response()->json([
            'success' => false,
            'suspended' => true,
            'message' => $wasteCheck['message'],
            'suspension_id' => $wasteCheck['suspension_id'],
            'waste_percentage' => $wasteCheck['waste_percentage'],
        ], 403);
    }
    
    return response()->json([
        'success' => true,
        'message' => 'ุชู ุงูุญูุธ ุจูุฌุงุญ',
        'waste_check' => $wasteCheck
    ]);
}
```

---

## ููููุฉ ุงูุชุทุจูู ูู ุงููุฑุญูุฉ ุงูุซุงููุฉ

### ูู `Stage2Controller.php`

```php
use App\Services\WasteCheckService;

public function store(Request $request)
{
    // ... ุงูููุฏ ุงูุญุงูู ...
    
    $coil = Stage2Coil::create([
        'input_weight' => $inputWeight,
        'output_weight' => $outputWeight,
        // ... ุจุงูู ุงูุญููู
    ]);
    
    // ๐ฅ ูุญุต ูุณุจุฉ ุงููุฏุฑ ูููุฑุญูุฉ ุงูุซุงููุฉ
    $wasteCheck = WasteCheckService::checkAndSuspendIfNeeded(
        stageNumber: 2,
        batchBarcode: $request->barcode,
        inputWeight: $inputWeight,
        outputWeight: $outputWeight,
        batchId: $coil->id,
        userId: Auth::id()
    );
    
    if ($wasteCheck['suspended']) {
        return response()->json([
            'success' => false,
            'suspended' => true,
            'message' => 'โ๏ธ ุชู ุฅููุงู ุงููุฑุญูุฉ ุงูุซุงููุฉ ุจุณุจุจ ุชุฌุงูุฒ ูุณุจุฉ ุงููุฏุฑ ุงููุณููุญ ุจูุง',
            'details' => $wasteCheck
        ], 403);
    }
    
    return response()->json([
        'success' => true,
        'data' => $coil
    ]);
}
```

---

## ุงูุชูุจููุงุช ุงูุชููุงุฆูุฉ

ุนูุฏ ุชุฌุงูุฒ ูุณุจุฉ ุงููุฏุฑุ ูุชู ุฅุฑุณุงู ุชูุจููุงุช ุฅูู:

1. **ุงููุณุชุฎุฏููู ุฐูู ุตูุงุญูุฉ `STAGE_SUSPENSION_APPROVE`**
2. **ุงููุณุชุฎุฏููู ุฐูู ุตูุงุญูุฉ `STAGE_SUSPENSION_VIEW`**
3. **ุงููุฏุฑุงุก (ADMIN)**

### ูุญุชูู ุงูุชูุจูู:
```
โ๏ธ ุชู ุฅููุงู ุงููุฑุญูุฉ [ุฑูู ุงููุฑุญูุฉ] ุชููุงุฆูุงู
ุงูุณุจุจ: ุชุฌุงูุฒ ูุณุจุฉ ุงููุฏุฑ ุงููุณููุญ ุจูุง
ุงููุณุจุฉ ุงููุนููุฉ: X%
ุงููุณููุญ ุจู: 3%
ุงูุจุงุฑููุฏ: XXX
```

---

## ุตูุญุฉ ุงููุฑุงุญู ุงููููููุฉ

### ุงููุตูู:
```
/stage-suspensions
```

### ุงูููุฒุงุช:
- โ ุนุฑุถ ุฌููุน ุงููุฑุงุญู ุงููููููุฉ
- โ ุชุตููุฉ ุญุณุจ ุงูุญุงูุฉ (ูุนูู / ูุนุชูุฏ / ูุฑููุถ)
- โ ุนุฑุถ ุชูุงุตูู ุงููุฏุฑ ููู ูุฑุญูุฉ
- โ ุงูููุงููุฉ ุนูู ุงุณุชุฆูุงู ุงููุฑุญูุฉ
- โ ุฑูุถ ุงุณุชุฆูุงู ุงููุฑุญูุฉ ูุน ููุงุญุธุงุช

---

## ุนูููุฉ ุงูููุงููุฉ ุนูู ุงูุงุณุชุฆูุงู

### 1. ุงููุณุชุฎุฏู ูุฐูุจ ุฅูู ุตูุญุฉ ุงููุฑุงุญู ุงููููููุฉ
```
Dashboard โ ุงููุฑุงุญู ุงููููููุฉ
```

### 2. ูุนุฑุถ ุชูุงุตูู ุงูุฅููุงู:
- ุฑูู ุงููุฑุญูุฉ
- ุงูุจุงุฑููุฏ
- ุงููุฒู ุงููุฏุฎู / ุงููุงุชุฌ
- ูุฒู ุงููุฏุฑ
- ูุณุจุฉ ุงููุฏุฑ ุงููุนููุฉ
- ุงููุณุจุฉ ุงููุณููุญ ุจูุง
- ุชุงุฑูุฎ ุงูุฅููุงู

### 3. ููุฑุฑ:
- **ุงูููุงููุฉ**: ุชุชู ุฅุนุงุฏุฉ ุชูุนูู ุงููุฑุญูุฉ ุชููุงุฆูุงู
- **ุงูุฑูุถ**: ุชุจูู ุงููุฑุญูุฉ ูููููุฉ ููููู ุฅุถุงูุฉ ููุงุญุธุงุช

---

## ูุซุงู ุนูู Response ุนูุฏ ุงูุชุฌุงูุฒ

```json
{
    "success": false,
    "suspended": true,
    "message": "โ๏ธ ุชู ุฅููุงู ุงููุฑุญูุฉ ุชููุงุฆูุงู ุจุณุจุจ ุชุฌุงูุฒ ูุณุจุฉ ุงููุฏุฑ",
    "suspension_id": 5,
    "stage_number": 1,
    "waste_percentage": 4.5,
    "allowed_percentage": 3.0,
    "waste_weight": 45.00,
    "input_weight": 1000.00,
    "output_weight": 955.00
}
```

---

## Helper Methods ุงููุชุงุญุฉ

### ูู `SystemSettingsHelper.php`:

```php
// ุงูุญุตูู ุนูู ูุณุจุฉ ุงููุฏุฑ ุงููุณููุญ ุจูุง
SystemSettingsHelper::getProductionWastePercentage(); // Returns: 3.0

// ูุญุต ูุณุจุฉ ุงููุฏุฑ
$check = SystemSettingsHelper::checkWastePercentage(
    stage: 1,
    inputWeight: 1000,
    outputWeight: 950
);

// ูุชูุฌุฉ ุงููุญุต:
[
    'exceeded' => true,
    'input_weight' => 1000.00,
    'output_weight' => 950.00,
    'waste_weight' => 50.00,
    'actual_waste' => 5.00,  // 5%
    'allowed_percentage' => 3.00,
    'difference' => 2.00,
    'should_alert' => true,
    'should_suspend' => true
]
```

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

### 1. ุชุทุจูู ุงููุญุต ูู Stage1Controller โ
### 2. ุชุทุจูู ุงููุญุต ูู Stage2Controller โ
### 3. ุฅุถุงูุฉ ุงูุตูุงุญูุงุช ูููุณุชุฎุฏููู ุงูููุงุณุจูู
### 4. ุงุฎุชุจุงุฑ ุงููุธุงู

---

## ููุงุญุธุงุช ูููุฉ

โ๏ธ **ุงููุฑุญูุฉ ุชูููู ุชููุงุฆูุงู** ุนูุฏ ุงูุชุฌุงูุฒ - ูุง ูููู ุงูุงุณุชูุฑุงุฑ ุญุชู ุงูููุงููุฉ
โ๏ธ **ุงูุชูุจููุงุช ููุฑูุฉ** - ูุชู ุฅุฑุณุงููุง ูุจุงุดุฑุฉ ุนูุฏ ุงูุฅููุงู
โ๏ธ **ุงูุณุฌู ูุงูู** - ูุชู ุญูุธ ุฌููุน ุงูุจูุงูุงุช ูู `stage_suspensions`
โ๏ธ **ุงูุตูุงุญูุงุช ุถุฑูุฑูุฉ** - ููุท ูู ูุฏูู ุตูุงุญูุฉ ููููู ุงูููุงููุฉ

---

## ุงูุตูุงูุฉ

ูุชุบููุฑ ูุณุจุฉ ุงููุฏุฑ ุงููุณููุญ ุจูุง:
```
Dashboard โ ุงูุฅุนุฏุงุฏุงุช โ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ โ waste_limits โ production_waste_percentage
```

ูุชุนุทูู/ุชูุนูู ุงูุฅููุงู ุงูุชููุงุฆู:
```
Dashboard โ ุงูุฅุนุฏุงุฏุงุช โ auto_suspend_on_waste_exceed
```
